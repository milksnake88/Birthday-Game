<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ í™©ì§€ì§± ìƒì¶• ê²Œì„</title>
  <style>
    :root { --bg:#0b0f1a; --ui:#e8eefc; --dim:#9bb0d6; --accent:#7cf7c1; --warn:#ff6b6b; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--ui); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; }
    .wrap { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; padding:16px; }
    canvas { image-rendering: pixelated; image-rendering: crisp-edges; border:2px solid #24304d; border-radius:12px; background: #050814; }
    .hud { width:min(720px, 96vw); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .panel { display:flex; gap:10px; align-items:center; flex-wrap:wrap; color:var(--dim); font-size:14px; }
    .kbd { padding:2px 8px; border:1px solid #2b3a5d; border-radius:8px; color:var(--ui); background:#0f1730; }
    button { cursor:pointer; border:1px solid #2b3a5d; background:#0f1730; color:var(--ui); border-radius:10px; padding:8px 12px; font-weight:700; }
    button:hover { border-color:#3b4f80; }

    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); padding:16px; }
    .card { width:min(560px, 96vw); background:#0f1730; border:1px solid #2b3a5d; border-radius:16px; padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .card h2 { margin:0 0 8px; font-size:18px; }
    .card p { margin:8px 0; color:var(--dim); line-height:1.5; }
    .secret {
      margin-top:10px; padding:12px; border-radius:12px; background:#071025; border:1px dashed #3b4f80;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      color: var(--accent);
      user-select: all;
      word-break: break-all;
      font-size: 16px;
    }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .big { font-size:22px; font-weight:900; letter-spacing:-0.02em; }
    canvas { width: min(720px, 96vw); height: auto; }
    .badge { padding:2px 8px; border-radius:999px; border:1px solid #2b3a5d; background:#071025; color:var(--ui); font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">
      <div class="panel">
        <span>ì´ë™ <span class="kbd">â†</span><span class="kbd">â†’</span> / ì‚¬ê²© <span class="kbd">Space</span></span>
        <span>ë¦¬ì…‹ <span class="kbd">R</span></span>
      </div>
      <div class="panel">
        <button id="btnStart">Start</button>
        <button id="btnMute">Sound: ON</button>
      </div>
    </div>

    <canvas id="c"></canvas>
    <!-- Mobile touch controls -->
    <div id="touchUI" style="
      width:min(720px,96vw);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:8px;
      touch-action:none;
    ">
      <div style="display:flex; gap:10px;">
        <button id="btnLeft"  style="width:86px; height:58px; font-size:18px;">â—€</button>
        <button id="btnRight" style="width:86px; height:58px; font-size:18px;">â–¶</button>
      </div>
      <button id="btnFire" style="width:120px; height:58px; font-size:16px;">FIRE</button>
    </div>

    <div class="panel">
      <span id="status">ë¯¸ì…˜: ìš°ì£¼ë¥¼ ëš«ê³  30ì´ˆ ìƒì¡´í•´ ì„ ë¬¼ ìƒìë¥¼ íšë“í•˜ë¼ ğŸš€</span>
    </div>
  </div>

  <!-- Gift modal -->
  <div class="modal" id="modal">
    <div class="card">
      <h2>ğŸ‰ ë¯¸ì…˜ ì„±ê³µ!</h2>
      <p>ì„ ë¬¼ ìƒìë¥¼ ì—´ë©´ â€œì§„ì§œ ì„ ë¬¼â€ì„ ë°›ê¸° ìœ„í•œ ì§€ë ¹ì´ ë‚˜ì˜¨ë‹¤.</p>
      <div class="row">
        <button id="btnOpenChest">ì„ ë¬¼ ìƒì ì—´ê¸°</button>
        <button id="btnClose">ë‹«ê¸°</button>
      </div>

      <div id="giftArea" style="display:none;">
        <p class="big" style="margin-top:12px;color:#e8eefc;">ğŸ“œ ì•„ë˜ ì½”ë“œë¥¼ ë¯¼ì§€ì—ê²Œ ì „ë‹¬í•˜ì‹œì˜¤</p>
        <div class="secret" id="fakeCode">HZ-BDAY-9Q7K-2M5P</div>
        <p style="font-size:12px;color:#7f93bd;">â€» ì´ ì½”ë“œëŠ” â€œê°€ì§œâ€ì´ë©°, ë¯¼ì§€ì—ê²Œ ë³´ë‚´ë©´ ì§„ì§œ ì„ ë¬¼ì´ ì†Œí™˜ë©ë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  let W = 720, H = 720;
  
  function resizeCanvas() {
    // í™”ë©´ í­ì— ë§ì¶° 16:9 ë¹„ìœ¨ ìœ ì§€(720x420 ë¹„ìœ¨ê³¼ ë™ì¼)
    const maxW = Math.min(720, Math.floor(window.innerWidth * 0.96));
    const newW = Math.max(320, maxW);              // ë„ˆë¬´ ì‘ì•„ì§€ëŠ” ê±° ë°©ì§€
    const newH = newW;
  
    // í˜„ì¬ ìœ„ì¹˜ ë¹„ìœ¨ ë³´ì¡´(ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìˆœê°„ì´ë™ ë°©ì§€)
    const xRatio = ship ? (ship.x / Math.max(1, W)) : 0.5;
  
    W = newW; H = newH;
  
    // CSS í‘œì‹œ í¬ê¸°
    canvas.style.width = W + "px";
    canvas.style.height = H + "px";
  
    // ì‹¤ì œ ë Œë”ë§ í•´ìƒë„(ë ˆí‹°ë‚˜ ëŒ€ì‘)
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(W * dpr);
    canvas.height = Math.floor(H * dpr);
  
    // ì´í›„ ê·¸ë¦¬ê¸°ëŠ” CSS í”½ì…€ ë‹¨ìœ„ë¡œ í•˜ë„ë¡ ìŠ¤ì¼€ì¼ ì ìš©
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  
    if (ship) {
      ship.x = Math.max(20, Math.min(W - 20, xRatio * W));
      ship.y = H - 60;
    }
  }


  // ---- CONFIG ----
  const SURVIVE_TIME = 30;                 // ë‚œì´ë„â†‘: ë” ì˜¤ë˜ ìƒì¡´
  const FAKE_CODE = "HZ-BDAY-9Q7K-2M5P";   // ê°€ì§œ ì½”ë“œ
  // ---------------

  // UI
  const statusEl = document.getElementById('status');
  const btnStart = document.getElementById('btnStart');
  const btnMute = document.getElementById('btnMute');
  const modal = document.getElementById('modal');
  const btnOpenChest = document.getElementById('btnOpenChest');
  const btnClose = document.getElementById('btnClose');
  const giftArea = document.getElementById('giftArea');
  const fakeCodeEl = document.getElementById('fakeCode');
  fakeCodeEl.textContent = FAKE_CODE;

  // Touch UI refs
  const touchUI = document.getElementById('touchUI');
  const btnLeft = document.getElementById('btnLeft');
  const btnRight = document.getElementById('btnRight');
  const btnFire = document.getElementById('btnFire');

  // Helper: press/release -> keys set
  function press(code) { keys.add(code); if (code === 'Space' && !running) start(); }
  function release(code) { keys.delete(code); }

  // Prevent scroll while playing (important on mobile)
  touchUI.addEventListener('touchstart', (e) => e.preventDefault(), { passive:false });
  touchUI.addEventListener('touchmove',  (e) => e.preventDefault(), { passive:false });

  function bindHold(btn, code) {
    const down = (e) => { e.preventDefault(); press(code); };
    const up   = (e) => { e.preventDefault(); release(code); };

    // Touch
    btn.addEventListener('touchstart', down, { passive:false });
    btn.addEventListener('touchend', up, { passive:false });
    btn.addEventListener('touchcancel', up, { passive:false });

    // Mouse (PCì—ì„œ í´ë¦­ í…ŒìŠ¤íŠ¸ìš©)
    btn.addEventListener('mousedown', down);
    window.addEventListener('mouseup', up);
  }

  bindHold(btnLeft, 'ArrowLeft');
  bindHold(btnRight, 'ArrowRight');

  // FIREëŠ” ëˆ„ë¥´ëŠ” ë™ì•ˆ ê³„ì† ë°œì‚¬ë˜ê²Œ Spaceì²˜ëŸ¼ ì²˜ë¦¬
  bindHold(btnFire, 'Space');

  
  // Simple sound
  let soundOn = true;
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function beep(freq=440, dur=0.05, gain=0.03) {
    if (!soundOn) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'square';
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur);
  }

  // Game state
  let running = false;
  let last = 0;
  let elapsed = 0;
  let score = 0;
  let hp = 2;                 // ë‚œì´ë„â†‘: HP ê°ì†Œ
  let shield = 0;             // seconds
  let rapid = 0;              // seconds
  let msg = "";
  let msgT = 0;

  const keys = new Set();

  const ship = { x: W/2, y: H-60, w: 18, h: 18, vx:0, speed: 320, cd: 0 };

  let bullets = [];
  let rocks = [];
  let shards = [];            // ìš°ì£¼ë¹„(íƒ„ë§‰)
  let pickups = [];           // íŒŒì›Œì—… ìƒì
  let stars = [];
  let fireworks = [];
  let boss = null;
  let bossSpawned = false;
  let victoryPending = false;


  // Events
  let eventTimer = 0;
  let currentEvent = null;    // "blackhole" | "meteor" | null
  let eventLeft = 0;

  function toast(text, sec=2.2) {
    msg = text; msgT = sec;
  }

  function reset() {
    running = false;
    last = 0;
    elapsed = 0;
    score = 0;
    hp = 2;
    shield = 0;
    rapid = 0;
    bullets = [];
    rocks = [];
    shards = [];
    pickups = [];
    stars = [];
    eventTimer = 2.5;
    currentEvent = null;
    eventLeft = 0;
    msg = ""; msgT = 0;

    ship.x = W/2; ship.y = H-60; ship.vx = 0; ship.cd = 0;

    for (let i=0;i<140;i++) stars.push({ x:Math.random()*W, y:Math.random()*H, s:1+Math.random()*2 });

    statusEl.textContent = `ë¯¸ì…˜: ìš°ì£¼ë¥¼ ëš«ê³  ${SURVIVE_TIME}ì´ˆ ìƒì¡´í•´ ì„ ë¬¼ ìƒìë¥¼ íšë“í•˜ë¼ ğŸš€`;
    giftArea.style.display = "none";
    modal.style.display = "none";
    btnStart.textContent = "Start";
    draw(0);
  }

  function start() {
    if (running) return;
    running = true;
    btnStart.textContent = "Runningâ€¦";
    audioCtx.resume?.();
    toast("ğŸš€ ì¶œë°œ! í™©ì§€ì§± ìš°ì£¼ë¥¼ ëš«ì–´ë¼!", 2.2);
    requestAnimationFrame(loop);
  }

  function win() {
    running = false;
    spawnFireworks(140); // ìˆ«ì ë†’ì„ìˆ˜ë¡ í™”ë ¤
    btnStart.textContent = "Restart";
    modal.style.display = "flex";
    beep(880, 0.08, 0.05); beep(988, 0.08, 0.05); beep(1175, 0.10, 0.06);
  }

  function lose() {
    running = false;
    btnStart.textContent = "Retry";
    statusEl.textContent = "ğŸ’¥ ì¶”ë½! Rë¡œ ë¦¬ì…‹í•˜ê±°ë‚˜ Startë¡œ ì¬ë„ì „!";
    beep(120, 0.15, 0.07);
  }

  function spawnRock(kind="normal") {
    const size = (kind==="big") ? (26 + Math.random()*14) : (12 + Math.random()*18);
    const x = 20 + Math.random()*(W-40);
    const base = 160 + Math.random()*300;
    const vy = base + elapsed*2.3;             // ë‚œì´ë„â†‘: ì‹œê°„ ì§€ë‚ ìˆ˜ë¡ ë¹ ë¦„
    const vx = (-70 + Math.random()*140);
    rocks.push({ x, y:-40, r:size, vx, vy, kind });
  }

  function spawnBossCake() {
    boss = {
      x: W / 2,
      y: -120,
      w: 220,
      h: 160,
      vy: 70,        // ë‚´ë ¤ì˜¤ëŠ” ì†ë„
      hp: 20         // ë§ì¶°ì•¼ í•˜ëŠ” ì´ì•Œ ìˆ˜(ë‚œì´ë„ ì¡°ì ˆ í¬ì¸íŠ¸)
    };
    bossSpawned = true;
    toast("ğŸ‚ ë³´ìŠ¤ ì¼€ì´í¬ ìš´ì„ ë“±ì¥! 10ì´ˆ ì•ˆì— ë°•ì‚´!!", 2.6);
    beep(140, 0.12, 0.06);
  }

  function spawnPickup() {
    const x = 40 + Math.random()*(W-80);
    const type = Math.random() < 0.5 ? "shield" : "rapid";
    pickups.push({ x, y:-20, vy: 180, type });
  }

  function spawnFireworks(count=80) {
    for (let i=0;i<count;i++) {
      fireworks.push({
        x: W/2,
        y: H/2,
        vx: (Math.random()-0.5)*500,
        vy: (Math.random()-0.5)*500,
        life: 1.2 + Math.random()*0.6
      });
    }
  }

  function shoot() {
    if (ship.cd > 0) return;
    const cd = rapid > 0 ? 0.07 : 0.16;
    ship.cd = cd;
    bullets.push({ x: ship.x, y: ship.y-12, vy: -620, p: rapid>0 ? 2 : 1 });
    beep(720, 0.03, 0.03);
  }

  function aabbCircle(ax, ay, aw, ah, cx, cy, cr) {
    const px = Math.max(ax, Math.min(cx, ax+aw));
    const py = Math.max(ay, Math.min(cy, ay+ah));
    const dx = cx - px, dy = cy - py;
    return (dx*dx + dy*dy) <= cr*cr;
  }

  function dist2(ax, ay, bx, by) { const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }

  function beginEvent() {
    // ì´ë²¤íŠ¸ëŠ” "ë¸”ë™í™€" ë˜ëŠ” "ìš°ì£¼ë¹„" ì¤‘ í•˜ë‚˜ + ê°€ë” íŒŒì›Œì—… ìƒì
    const roll = Math.random();
    if (roll < 0.45) {
      currentEvent = "blackhole";
      eventLeft = 6.5;
      toast("ğŸŒ€ ë¸”ë™í™€! ì¢Œìš°ë¡œ ëŒë ¤ê°„ë‹¤!", 2.3);
      beep(200, 0.10, 0.05);
    } else {
      currentEvent = "meteor";
      eventLeft = 6.0;
      toast("â˜„ï¸ ì¼€ì´í¬ ìš´ì„ë¹„! ìƒì¼ ì¶•í•˜ë‹¤!!", 2.3);
      beep(260, 0.10, 0.05);
    }

    // ì´ë²¤íŠ¸ ì‹œì‘ ì‹œ 100% í™•ë¥ ë¡œ íŒŒì›Œì—… ìƒì 1ê°œ
    if (Math.random() < 1.0) spawnPickup();
    if (Math.random() < 1.0) spawnPickup();
  }

  function update(dt) {
    // Boss spawn: 20ì´ˆ ë‚¨ì•˜ì„ ë•Œ 1íšŒ ë“±ì¥
    const remain = SURVIVE_TIME - elapsed;
    if (!bossSpawned && remain <= 20) {
      spawnBossCake();
    }
    // Boss update
    if (boss) {
      boss.y += boss.vy * dt;
    
      // ì´ì•Œì´ ë³´ìŠ¤ì— ë§ìœ¼ë©´ hp ê°ì†Œ
      for (let j = bullets.length - 1; j >= 0; j--) {
        const b = bullets[j];
    
        const hit =
          b.x >= boss.x - boss.w/2 && b.x <= boss.x + boss.w/2 &&
          b.y >= boss.y - boss.h/2 && b.y <= boss.y + boss.h/2;
    
        if (hit) {
          bullets.splice(j, 1);
          boss.hp -= 1 * (rapid > 0 ? 1 : 1);   // ì—°ì‚¬ íŒŒì›Œì—…ì´ë©´ ë” ë§ì´ ê¹ì„
          score += 2;
          beep(620, 0.02, 0.03);
    
          if (boss.hp <= 0) {
            spawnFireworks(180);
            return;
          }

        }
      }
    }

    elapsed += dt;
    if (msgT > 0) msgT -= dt;

    // Stars
    for (const s of stars) {
      s.y += (55 + s.s*45) * dt;
      if (s.y > H) { s.y = -5; s.x = Math.random()*W; }
    }

    // Timers
    ship.cd = Math.max(0, ship.cd - dt);
    shield = Math.max(0, shield - dt);
    rapid = Math.max(0, rapid - dt);

    // Events schedule (ë‚œì´ë„â†‘: ë” ìì£¼)
    eventTimer -= dt;
    if (eventTimer <= 0 && !currentEvent && elapsed > 5) {
      beginEvent();
      eventTimer = 7.5 + Math.random()*4.0; // ë‹¤ìŒ ì´ë²¤íŠ¸ê¹Œì§€
    }

    if (currentEvent) {
      eventLeft -= dt;
      if (currentEvent === "meteor") {
        // ìš°ì£¼ë¹„ íƒ„ë§‰: ì‘ì€ íŒŒí¸ ìƒì„±
        const rate = 3 + elapsed*0.12; // sec^-1
        const n = Math.random() < rate*dt ? 1 : 0;
        for (let i=0;i<n;i++) {
          const x = Math.random()*W;
          const vy = 260 + Math.random()*240;
          const vx = (-60 + Math.random()*120);
          const r = 5 + Math.random()*5;
          shards.push({
            x, y:-10, vx, vy, r,
            hp: (r > 8 ? 2 : 1)   // í° ì¼€ì´í¬ëŠ” 2ë°œ, ì‘ì€ ê±´ 1ë°œ
          });

        }
      }
      if (eventLeft <= 0) {
        currentEvent = null;
        toast("âœ… ì´ë²¤íŠ¸ ì¢…ë£Œ. ìˆ¨ ê³ ë¥´ê³  ê³„ì†!", 1.5);
      }
    }

    // Ship control (ë¸”ë™í™€ ì´ë²¤íŠ¸ ì‹œ ëŒë¦¼)
    ship.vx = 0;
    if (keys.has('ArrowLeft')) ship.vx -= ship.speed;
    if (keys.has('ArrowRight')) ship.vx += ship.speed;

    if (currentEvent === "blackhole") {
      // ì¤‘ì•™(í˜¹ì€ ëœë¤ ì¤‘ì‹¬)ìœ¼ë¡œ ëŒì–´ë‹¹ê¸°ëŠ” ëŠë‚Œ
      const center = W/2 + Math.sin(elapsed*1.8)*110;
      const pull = (center - ship.x) * 1.8;  // px/s ì¶”ê°€ ê°€ì†
      ship.vx += pull;
    }

    ship.x += ship.vx * dt;
    ship.x = Math.max(20, Math.min(W-20, ship.x));

    // Shooting
    shoot();

    // Bullets
    for (const b of bullets) b.y += b.vy * dt;
    bullets = bullets.filter(b => b.y > -40);

    // Spawn rocks (ë‚œì´ë„â†‘: ë” ìì£¼ + big ì„ì„)
    const baseRate = 1.10 + Math.min(1.9, elapsed/18); // sec^-1
    if (Math.random() < baseRate * dt) spawnRock(Math.random()<0.18 ? "big" : "normal");

    // occasional pickup even without event
    if (Math.random() < (0.02 * dt)) spawnPickup();

    // Rocks move
    for (const r of rocks) {
      r.x += r.vx * dt;
      r.y += r.vy * dt;
      if (r.x < 15 || r.x > W-15) r.vx *= -1;
    }

    // Shards move
    for (const s of shards) {
      s.x += s.vx * dt;
      s.y += s.vy * dt;
      if (s.x < -20) s.x = W+20;
      if (s.x > W+20) s.x = -20;
    }
    shards = shards.filter(s => s.y < H+40);

    // Pickups move
    for (const p of pickups) p.y += p.vy * dt;
    pickups = pickups.filter(p => p.y < H+40);

    // Bullet vs rock
    for (let i=rocks.length-1;i>=0;i--) {
      const r = rocks[i];
      for (let j=bullets.length-1;j>=0;j--) {
        const b = bullets[j];
        if (dist2(r.x, r.y, b.x, b.y) < (r.r+4)*(r.r+4)) {
          // big rock needs more hits
          if (r.kind === "big") {
            r.r -= 10 * b.p;
            bullets.splice(j,1);
            score += 6;
            beep(520, 0.03, 0.03);
            if (r.r <= 14) {
              rocks.splice(i,1);
              score += 12;
              beep(640, 0.05, 0.04);
            }
          } else {
            rocks.splice(i,1);
            bullets.splice(j,1);
            score += 10;
            beep(520, 0.04, 0.03);
          }
          break;
        }
      }
    }
    // Bullet vs shards (cake meteors)
    for (let i = shards.length - 1; i >= 0; i--) {
      const s = shards[i];
      for (let j = bullets.length - 1; j >= 0; j--) {
        const b = bullets[j];
    
        const dx = s.x - b.x, dy = s.y - b.y;
        if (dx*dx + dy*dy < (s.r + 6) * (s.r + 6)) {
          // hit!
          bullets.splice(j, 1);
          s.hp -= (rapid > 0 ? 2 : 1);  // ì—°ì‚¬(rapid) ì¤‘ì´ë©´ ë” ì˜ ë¶€ìˆ¨
          score += 3;
          beep(560, 0.03, 0.03);
    
          if (s.hp <= 0) {
            shards.splice(i, 1);
            score += 2;
            beep(720, 0.04, 0.03);
          }
          break; // í•œ ì´ì•Œì€ í•œ ë²ˆë§Œ íŒì •
        }
      }
    }

    // Collisions: ship vs rock/shard
    const shipRect = { x: ship.x-ship.w/2, y: ship.y-ship.h/2, w: ship.w, h: ship.h };

    function takeHit() {
      if (shield > 0) { beep(980, 0.03, 0.03); return; }
      hp -= 1;
      beep(180, 0.08, 0.06);
      toast("ğŸ’¥ í”¼ê²©! ì •ì‹  ì°¨ë ¤!", 1.2);
      if (hp <= 0) lose();
    }

    for (let i=rocks.length-1;i>=0;i--) {
      const r = rocks[i];
      if (aabbCircle(shipRect.x, shipRect.y, shipRect.w, shipRect.h, r.x, r.y, r.r)) {
        rocks.splice(i,1);
        takeHit();
        if (!running) return;
      }
    }
    for (let i=shards.length-1;i>=0;i--) {
      const s = shards[i];
      if (aabbCircle(shipRect.x, shipRect.y, shipRect.w, shipRect.h, s.x, s.y, s.r)) {
        shards.splice(i,1);
        takeHit();
        if (!running) return;
      }
    }

    // Ship vs pickup
    for (let i=pickups.length-1;i>=0;i--) {
      const p = pickups[i];
      if (aabbCircle(shipRect.x, shipRect.y, shipRect.w, shipRect.h, p.x, p.y, 12)) {
        pickups.splice(i,1);
        if (p.type === "shield") {
          shield = 6.5;
          toast("ğŸ›¡ï¸ ì‹¤ë“œ ON (6.5ì´ˆ)", 2.0);
          beep(900, 0.06, 0.05);
        } else {
          rapid = 6.0;
          toast("âš¡ ì—°ì‚¬ ON (6ì´ˆ)", 2.0);
          beep(780, 0.06, 0.05);
        }
      }
    }

    // Cleanup rocks
    rocks = rocks.filter(r => r.y < H+60);

    // Win condition
    if (elapsed >= SURVIVE_TIME) {
      win();
    }


    // Status
    statusEl.textContent =
      `ğŸ‚ í™©ì§€ì§± ìƒì¶• | â± ${(SURVIVE_TIME-elapsed).toFixed(1)}s | â¤ï¸ ${hp} | ğŸ›¡ï¸ ${shield>0?shield.toFixed(1):'0.0'} | âš¡ ${rapid>0?rapid.toFixed(1):'0.0'} | â­ ${score}`;
    //  fireworks update
    for (const f of fireworks ) {
      f.x += f.vx * dt;
      f.y += f.vy * dt;
      f.life -= dt;
    }
    
    fireworks = fireworks.filter(f => f.life > 0);

  }

  function drawPixelShip(x, y) {
    const px = 3;
    const sx = Math.round(x), sy = Math.round(y);
    const data = [
      "00100",
      "01110",
      "11111",
      "01110",
      "10101"
    ];
    // ship body
    ctx.fillStyle = "#ffd36a";
    for (let r=0;r<data.length;r++){
      for (let c=0;c<data[r].length;c++){
        if (data[r][c]==="1"){
          ctx.fillRect(sx + (c-2)*px, sy + (r-2)*px, px, px);
        }
      }
    }
    // flame
    if (running && Math.random()<0.9) {
      ctx.fillStyle = "#ff6b6b";
      ctx.fillRect(sx-1, sy+10, 3, 4);
    }

    // shield ring
    if (shield > 0) {
      ctx.globalAlpha = 0.8;
      ctx.strokeStyle = "#7cf7c1";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(sx, sy, 16, 0, Math.PI*2);
      ctx.stroke();
      ctx.globalAlpha = 1;
    }
  }

  function drawPlanetProgress() {
    const p = Math.min(1, elapsed / SURVIVE_TIME);
    const cx = W-70, cy = 70;

    ctx.save();
    ctx.globalAlpha = 0.9;
    ctx.strokeStyle = "#2b3a5d";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(cx, cy, 28, 0, Math.PI*2);
    ctx.stroke();

    ctx.globalAlpha = 1;
    ctx.fillStyle = "#4fd0ff";
    ctx.beginPath();
    ctx.arc(cx, cy, 10 + 14*p, 0, Math.PI*2);
    ctx.fill();

    const ang = -Math.PI/2 + p*2*Math.PI;
    ctx.fillStyle = "#7cf7c1";
    ctx.beginPath();
    ctx.arc(cx + Math.cos(ang)*28, cy + Math.sin(ang)*28, 3, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
  }

  function drawOverlayTitle() {
    ctx.fillStyle = "rgba(0,0,0,0.60)";
    ctx.fillRect(0,0,W,H);

    ctx.fillStyle = "#e8eefc";
    ctx.font = "900 28px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText("í™©ì§€ì§± ìƒì¶•", 22, 86);

    ctx.fillStyle = "#9bb0d6";
    ctx.font = "14px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText("ë¯¸ì…˜: 40ì´ˆ ìƒì¡´ â†’ ì„ ë¬¼ ìƒì", 22, 116);
    ctx.fillText("â† â†’ ì´ë™ / Space ì‚¬ê²© / R ë¦¬ì…‹  (ë‚œì´ë„: ìƒ)", 22, 138);

    ctx.fillStyle = "#7cf7c1";
    ctx.font = "13px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.fillText("íŒ: íŒŒì›Œì—… ìƒì(ğŸ›¡ï¸/âš¡)ë¥¼ ë¨¹ìœ¼ë©´ ìƒì¡´ì´ ì‰¬ì›Œì§", 22, 162);
  }

  function drawToast() {
    if (msgT <= 0) return;
    ctx.save();
    ctx.globalAlpha = Math.min(1, msgT/0.4);
    ctx.fillStyle = "rgba(15,23,48,0.92)";
    ctx.fillRect(14, 52, W-28, 34);
    ctx.strokeStyle = "#2b3a5d";
    ctx.strokeRect(14, 52, W-28, 34);
    ctx.fillStyle = "#e8eefc";
    ctx.font = "700 14px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText(msg, 24, 74);
    ctx.restore();
  }

  function drawEventFX() {
    if (currentEvent === "blackhole") {
      const center = W/2 + Math.sin(elapsed*1.8)*110;
      ctx.save();
      ctx.globalAlpha = 0.20;
      ctx.fillStyle = "#7cf7c1";
      ctx.beginPath();
      ctx.arc(center, H*0.35, 70, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 0.14;
      ctx.beginPath();
      ctx.arc(center, H*0.35, 120, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
    if (currentEvent === "meteor") {
      ctx.save();
      ctx.globalAlpha = 0.10;
      ctx.fillStyle = "#ff6b6b";
      ctx.fillRect(0, 44, W, H-44);
      ctx.restore();
    }
  }

  function draw(dt) {
    ctx.clearRect(0,0,W,H);

    // stars
    ctx.fillStyle = "#ffffff";
    for (const s of stars) ctx.fillRect(s.x, s.y, 1, 1);

    // top HUD strip
    ctx.fillStyle = "rgba(15,23,48,0.92)";
    ctx.fillRect(0,0,W,44);

    ctx.fillStyle = "#e8eefc";
    ctx.font = "900 14px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.fillText("í™©ì§€ì§± ìƒì¶•", 14, 28);

    // event fx
    drawEventFX();

    // rocks
    for (const r of rocks) {
      ctx.fillStyle = (r.kind==="big") ? "#ffd36a" : "#c7d2ff";
      ctx.beginPath(); ctx.arc(r.x, r.y, r.r, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#8aa0d6";
      ctx.fillRect(r.x - r.r/2, r.y - r.r/2, 3, 3);
    }
    // Boss draw (giant cake)
    if (boss) {
      const x = boss.x, y = boss.y;
    
      // ì¼€ì´í¬ ëª¸í†µ
      ctx.fillStyle = "#ff9ecb";
      ctx.fillRect(x - boss.w/2, y - boss.h/2, boss.w, boss.h);
    
      // í¬ë¦¼ ì¸µ
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(x - boss.w/2, y - boss.h/2, boss.w, 18);
    
      // ë”¸ê¸° ì¥ì‹(ì—¬ëŸ¬ ê°œ)
      ctx.fillStyle = "#ff3b6b";
      for (let i=0; i<7; i++) {
        ctx.beginPath();
        ctx.arc(x - boss.w/2 + 25 + i*30, y - boss.h/2 - 6, 6, 0, Math.PI*2);
        ctx.fill();
      }
    
      // HP ë°”
      const barW = 240;
      const ratio = Math.max(0, boss.hp) / 80; // spawnBossCake hpë‘ ë§ì¶°ì•¼ í•¨
      ctx.fillStyle = "rgba(0,0,0,0.35)";
      ctx.fillRect(W/2 - barW/2, 54, barW, 10);
      ctx.fillStyle = "#7cf7c1";
      ctx.fillRect(W/2 - barW/2, 54, barW * ratio, 10);
    
      ctx.fillStyle = "#e8eefc";
      ctx.font = "700 12px system-ui";
      ctx.fillText("BOSS CAKE", W/2 - barW/2, 48);
    }

    // cake meteors ğŸ°
    for (const s of shards) {
    
      // ì¼€ì´í¬ ëª¸í†µ
      ctx.fillStyle = "#ff9ecb";
      ctx.fillRect(s.x-6, s.y-4, 12, 8);
    
      // í¬ë¦¼
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(s.x-6, s.y-7, 12, 3);
    
      // ë”¸ê¸°
      ctx.fillStyle = "#ff3b6b";
      ctx.beginPath();
      ctx.arc(s.x, s.y-9, 2, 0, Math.PI*2);
      ctx.fill();
    }
    

    // bullets
    ctx.fillStyle = "#7cf7c1";
    for (const b of bullets) ctx.fillRect(b.x-1, b.y-7, 2, 10);

    // pickups
    for (const p of pickups) {
      ctx.fillStyle = "#0f1730";
      ctx.fillRect(p.x-8, p.y-8, 16, 16);
      ctx.strokeStyle = "#2b3a5d";
      ctx.strokeRect(p.x-8, p.y-8, 16, 16);
      ctx.font = "16px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.fillText(p.type==="shield" ? "ğŸ›¡ï¸" : "âš¡", p.x-8, p.y+6);


    }

    // ship
    drawPixelShip(ship.x, ship.y);

    // planet progress
    drawPlanetProgress();

    // floor strip
    ctx.fillStyle = "rgba(43,58,93,0.35)";
    ctx.fillRect(0,H-30,W,30);

    // toast
    drawToast();

    if (!running) drawOverlayTitle();

        // fireworks draw
    for (const f of fireworks) {
    
      ctx.globalAlpha = Math.max(0, f.life);
    
      ctx.fillStyle = `hsl(${Math.random()*360},100%,70%)`;
    
      ctx.fillRect(f.x, f.y, 4, 4);
    }
    
    ctx.globalAlpha = 1;
    
    // ìƒì¼ í…ìŠ¤íŠ¸
    if (fireworks.length > 0) {
    
      ctx.fillStyle = "#ffffff";
    
      ctx.font = "900 42px system-ui";
    
      ctx.textAlign = "center";
    
      ctx.fillText("ğŸ‚ í™©ì§€ì§± ìƒì¼ì¶•í•˜í•´!!!! ğŸ‚", W/2, H/2);
    
      ctx.textAlign = "start";
    }

  }

  function loop(ts) {
    if (!running) return;
    if (!last) last = ts;
    const dt = Math.min(0.033, (ts-last)/1000);
    last = ts;
    update(dt);
    draw(dt);
    requestAnimationFrame(loop);
  }

  // Inputs
  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); keys.add('Space'); if (!running) start(); }
    else keys.add(e.code);
    if (e.code === 'KeyR') reset();
  });
  window.addEventListener('keyup', (e) => {
    if (e.code === 'Space') keys.delete('Space');
    else keys.delete(e.code);
  });

  btnStart.addEventListener('click', () => running ? null : start());
  btnMute.addEventListener('click', () => {
    soundOn = !soundOn;
    btnMute.textContent = `Sound: ${soundOn ? 'ON' : 'OFF'}`;
    if (soundOn) beep(660, 0.04, 0.03);
  });

  btnOpenChest.addEventListener('click', () => {
    giftArea.style.display = "block";
    beep(1046, 0.06, 0.05); beep(1318, 0.08, 0.05);
  });
  btnClose.addEventListener('click', () => modal.style.display = "none");
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = "none"; });

  // init
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  reset();
})();
</script>
</body>
</html>

